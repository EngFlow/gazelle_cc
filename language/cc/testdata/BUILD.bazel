load("@bazel_skylib//lib:paths.bzl", "paths")
load("@gazelle//:def.bzl", "gazelle_binary")
load("@rules_bazel_integration_test//bazel_integration_test:defs.bzl", "default_test_runner")
load("//bazel:gazelle_compilation_test.bzl", "gazelle_compilation_test_suite")
load("//bazel:gazelle_generation_test.bzl", "gazelle_generation_test_suite")

# Exclude this entire directly from having anything gnerated by Gazelle. That
# way the test cases won't be fixed by `bazel run //:gazelle` when run in this
# repository.
# gazelle:exclude **

# This test Gazelle binary only has the "//language/cc" plugin installed.
gazelle_binary(
    name = "gazelle_cc",
    languages = [
        "@gazelle//language/proto",
        "//language/cc",
    ],
    visibility = ["//visibility:private"],
)

default_test_runner(
    name = "compilation_test_runner",
    bazel_cmds = ["--nosystem_rc --nohome_rc build //..."],  # exclude external rc files for a hermetic build
)

ALL_TEST_DIRS = [paths.dirname(p) for p in glob([
    "**/MODULE.bazel",
    "**/WORKSPACE",
])]

COMPILATION_TEST_DIRS = [
    "virtual_include_paths",
]

gazelle_generation_test_suite(
    name = "generation_tests",
    size = "small",
    gazelle_binary = ":gazelle_cc",
    test_data_map = {test_dir + "_generation_test": glob([test_dir + "/**"]) for test_dir in ALL_TEST_DIRS},
)

gazelle_compilation_test_suite(
    name = "compilation_tests",
    size = "medium",
    test_runner = ":compilation_test_runner",
    test_data_map = {test_dir + "_compilation_test": glob([test_dir + "/**"]) for test_dir in COMPILATION_TEST_DIRS},
)
